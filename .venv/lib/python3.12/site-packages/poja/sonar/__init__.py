import poja.sed as sed
import os
import re


def set_sonar(dir, exclude):
    sonar_plugins = """id "org.sonarqube" version "4.4.1.3373" """
    sonar_conf = """sonarqube {
    properties {
        property "sonar.java.source", "21"
        property "sonar.java.target", "21"
    }
} """
    sonar_env = """env:
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} """
    sonar_ci = """- name: Cache SonarCloud packages
        uses: actions/cache@v2
        with:
          path: ~/.sonar/cache
          key: sonar-${{ runner.os }}-${{ hashFiles('build.gradle') }}
          restore-keys: sonar-${{ runner.os }}-

      - name: Code quality and coverage analysis
        run: |
         ./gradlew sonarqube --info \\
         -Dsonar.host.url=https://sonarcloud.io \\
         -Dsonar.organization=${{ vars.SONAR_ORG }} \\
         -Dsonar.projectKey=${{ vars.SONAR_PJ_KEY }} \\
         -Dsonar.projectName=${{ vars.SONAR_PJ_NAME }} \\
         -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \\
         -Dsonar.java.checkstyle.reportPaths=build/reports/checkstyle/main.xml,build/reports/checkstyle/test.xml
 """

    ignore_generated_files(dir)
    sed.find_replace(dir, "<?sonar-java-plugins>", sonar_plugins, exclude)
    sed.find_replace(dir, "<?sonar-conf>", sonar_conf, exclude)
    sed.find_replace(dir, "<?sonar-env>", sonar_env, exclude)
    sed.find_replace(dir, "<?sonar-ci>", sonar_ci, exclude)


def process_file(file_path):
    with open(file_path, "r") as file:
        lines = file.readlines()

    modified_lines = []
    generated_annotation_pattern = re.compile(r"@\w+Generated")

    for i, line in enumerate(lines):
        modified_lines.append(line)
        if generated_annotation_pattern.search(line):
            if i + 1 < len(lines) and "@SuppressWarnings" not in lines[i + 1]:
                modified_lines.append('@SuppressWarnings("all")\n')

    with open(file_path, "w") as file:
        file.writelines(modified_lines)


def ignore_generated_files(directory):
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith(".java"):
                file_path = os.path.join(root, file)
                process_file(file_path)
