from poja.utils import (
    remove_file_if_exists,
    remove_dir_if_exists,
    remove_some_lines_in_file_if_exists,
)
import poja.sed as sed


def set_event_stack(with_queues_nb, dir, exclude):
    if with_queues_nb == 0:
        set_no_event_stack(dir, exclude)
    else:
        event_stack_env_vars = """AWS_EVENTBRIDGE_BUS: !Sub '{{resolve:ssm:/<?app-name>/${Env}/eventbridge/bus-name}}'
        AWS_EVENT_STACK_1_SQS_QUEUE_URL: !Sub '{{resolve:ssm:/<?app-name>/${Env}/1/sqs/mailbox-queue-url}}'
        AWS_EVENT_STACK_2_SQS_QUEUE_URL: !Sub '{{resolve:ssm:/<?app-name>/${Env}/2/sqs/mailbox-queue-url}}'"""
        sed.find_replace(dir, "<?event-stacks-env-vars>", event_stack_env_vars, exclude)


def set_no_event_stack(dir, exclude):
    sed.find_replace(dir, "<?event-stacks-env-vars>", "", exclude)
    remove_file_if_exists(f"{dir}/.github/workflows/cd-event.yml")
    remove_file_if_exists(f"{dir}/cf-stacks/event-stack.yml")
    remove_file_if_exists(
        f"{dir}/src/main/java/school/hei/poja/concurrency/Workers.java"
    )
    remove_file_if_exists(
        f"{dir}/src/main/java/school/hei/poja/MailboxEventHandler.java"
    )
    remove_file_if_exists(
        f"{dir}/src/main/java/school/hei/poja/endpoint/rest/controller/health/HealthEventController.java"
    )
    remove_dir_if_exists(f"{dir}/src/main/java/school/hei/poja/service/event")
    remove_dir_if_exists(f"{dir}/src/main/java/school/hei/poja/endpoint/event")
    remove_dir_if_exists(f"{dir}/src/test/java/school/hei/poja/endpoint/event")
    remove_file_if_exists(f"{dir}/src/test/java/school/hei/poja/conf/EventConf.java")
    remove_file_if_exists(
        f"{dir}/src/test/java/school/hei/poja/unit/ConsumableEventTyperTest.java"
    )

    remove_some_lines_in_file_if_exists(
        f"{dir}/.github/workflows/health-check-infra.yml",
        "check-async-stack",
        "/health/event2",
        False,
    )
    remove_some_lines_in_file_if_exists(
        f"{dir}/src/test/java/school/hei/poja/conf/FacadeIT.java",
        "new EventConf",
        "new EventConf",
        False,
    )
    remove_some_lines_in_file_if_exists(
        f"{dir}/template.yml",
        "WorkerFunction1",
        "WorkerFunction2",
        True,
    )
    remove_some_lines_in_file_if_exists(
        f"{dir}/template.yml",
        "WorkerFunction2",
        "ApplicationResourceGroup",
        True,
    )
