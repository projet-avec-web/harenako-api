import os
import shutil
import importlib.resources as pkg_resources

from poja.utils import remove_some_lines_in_file_if_exists, remove_file_if_exists


def set_database_none(with_database, temp):
    if with_database == "none":
        os.remove(f"{temp}/.github/workflows/health-check-infra.yml")
        os.remove(f"{temp}/.shell/checkAsyncStack.sh")
        remove_file_if_exists(
            f"{temp}/src/main/java/school/hei/poja/endpoint/event/model/DurablyFallibleUuidCreated1.java"
        )
        remove_file_if_exists(
            f"{temp}/src/main/java/school/hei/poja/endpoint/event/model/DurablyFallibleUuidCreated2.java"
        )
        remove_file_if_exists(
            f"{temp}/src/main/java/school/hei/poja/endpoint/rest/controller/health/HealthEventController.java"
        )
        os.remove(
            f"{temp}/src/main/java/school/hei/poja/endpoint/rest/controller/health/HealthDbController.java"
        )
        os.remove(f"{temp}/src/main/java/school/hei/poja/repository/model/Dummy.java")
        os.remove(
            f"{temp}/src/main/java/school/hei/poja/repository/model/DummyUuid.java"
        )
        os.remove(
            f"{temp}/src/main/java/school/hei/poja/repository/DummyRepository.java"
        )
        os.remove(
            f"{temp}/src/main/java/school/hei/poja/repository/DummyUuidRepository.java"
        )
        remove_file_if_exists(
            f"{temp}/src/main/java/school/hei/poja/service/event/DurablyFallibleUuidCreated1Service.java"
        )
        remove_file_if_exists(
            f"{temp}/src/main/java/school/hei/poja/service/event/DurablyFallibleUuidCreated2Service.java"
        )
        remove_file_if_exists(
            f"{temp}/src/main/java/school/hei/poja/service/event/UuidCreatedService.java"
        )
        os.remove(f"{temp}/src/test/java/school/hei/poja/conf/PostgresConf.java")
        os.remove(f"{temp}/src/test/java/school/hei/poja/conf/SqliteConf.java")
        shutil.rmtree(f"{temp}/src/main/resources/db")
        shutil.rmtree(f"{temp}/src/test/java/school/hei/poja/endpoint")

        mailbox_event_handler_path = pkg_resources.files("poja.database.none").joinpath(
            "MailBoxEventHandler.java"
        )
        ping_controller_path = pkg_resources.files("poja.database.none").joinpath(
            "PingController.java"
        )
        override_file_content(
            f"{temp}/src/main/java/school/hei/poja/MailboxEventHandler.java",
            mailbox_event_handler_path,
        )
        override_file_content(
            f"{temp}/src/main/java/school/hei/poja/endpoint/rest/controller/health/PingController.java",
            ping_controller_path,
        )
        remove_some_lines_in_file_if_exists(
            f"{temp}/.github/workflows/cd-compute.yml",
            "health-check-infra:",
            "secrets: inherit",
            False,
        )
        remove_some_lines_in_file_if_exists(
            f"{temp}/build.gradle",
            "spring-boot-starter-data-jpa",
            "hibernate-community-dialects",
            False,
        )


def override_file_content(original_file_path, modified_file_path):
    with open(modified_file_path, "r") as modified:
        modified_content = modified.read()
    with open(original_file_path, "w") as original:
        original.write(modified_content)
